name: Moments Discovery dashgn0011

on:
  workflow_dispatch:

jobs:
  discovery:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        worker: [0, 1, 2]
    steps:
      - name: Setup
        run: pip install requests

      - name: Create and run discovery
        env:
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          WORKER: ${{ matrix.worker }}
          WORKFLOW_OFFSET: '12'
        run: |
          cat << 'SCRIPT' > discover.py
          import os, json, time, random, requests

          SUPABASE_URL = "https://anmgyxhnyhbyxzpjhxgx.supabase.co"
          SUPABASE_KEY = os.environ['SUPABASE_KEY']
          WORKER = int(os.environ.get('WORKER', '0'))
          WORKFLOW_OFFSET = int(os.environ.get('WORKFLOW_OFFSET', '0'))

          GEMINI_KEYS = ["AIzaSyAxXuWxcD1CN08lsoJlcUL6uBcLJEyXBFk","AIzaSyA06zIDz7H5waHAI4Y7pm6goewWgf5fjSA","AIzaSyCYrl0-t2xS0NZ4aSEQ-ZUZvCu-KoKftc8","AIzaSyD10bR8ttgOxQok8rcOq7jc_yF00UBQn14","AIzaSyBKZmoLt4bxNDZlq8LB9h0YMDWshgMxQ7M","AIzaSyCwiS0cu23sVwxj2kVOU72zFkdXfpDQdes","AIzaSyB86yrjm-J6IRhCAHxSBibyHiFtrHO3x8s","AIzaSyDokhvEBX5O8UNO2oELV6b8yX3wjBmGJVc","AIzaSyACh0veq7t8rzn6GQffS_5VSQlNN7g8rYc","AIzaSyBiukubVZHnxQOHSmgs5KBePbXaOC0CVrA","AIzaSyBlQtC75xy3mtvFh1jlD2V9hCL3ZWgdAL0","AIzaSyCsz2Q9c1XcUpDHm-mpzdPScNCoqDCf6bg","AIzaSyDYQp4_cczG_9ckibyp7Zf8L0TIbIxCnec","AIzaSyAZvM9erouQMYMAUl6At83391uuQMj8Ckk","AIzaSyCydxSRPNbN08nO6QXN95RR7UUdtDSQNX4","AIzaSyCdWnesc8Svykwb0yF2UQl18_fsNJYOiVg","AIzaSyBmIjEMvUnM80Pk3FcenKP_yoippgHkT1M","AIzaSyBQsI8Z3mBF1dWuHBo3Sbv0Rpvt4zNwV_4","AIzaSyAWqEvMZ5po-rX8ADwuc4ja6typ6YuGbeE"]
          KEY_INDEX = (WORKFLOW_OFFSET + WORKER) % len(GEMINI_KEYS)
          GEMINI_KEY = GEMINI_KEYS[KEY_INDEX]

          TARGETS = [{'id': 'instagram-afrobeats', 'focus': 'Afrobeats dance reels'},{'id': 'tiktok-amapiano', 'focus': 'Amapiano dance challenges'},{'id': 'instagram-afro-fashion', 'focus': 'African fashion with music'},{'id': 'tiktok-african-comedy', 'focus': 'African comedy skits'},{'id': 'instagram-lagos-vibes', 'focus': 'Lagos lifestyle'},{'id': 'ghana-highlife', 'focus': 'Ghanaian highlife'},{'id': 'kenya-gengetone', 'focus': 'Kenyan gengetone'},{'id': 'francophone-coupe', 'focus': 'Coupe-decale'},{'id': 'uk-afroswing', 'focus': 'UK Afroswing'},{'id': 'diaspora-vibes', 'focus': 'African diaspora'},{'id': 'dance-challenges', 'focus': 'Viral dance challenges'},{'id': 'music-reactions', 'focus': 'Music reactions'},{'id': 'street-performers', 'focus': 'Raw talent'},{'id': 'producer-beats', 'focus': 'African producers'},{'id': 'throwback-classics', 'focus': 'Classic clips'},{'id': 'emerging-artists', 'focus': 'New artists'},{'id': 'live-performances', 'focus': 'Concert clips'},{'id': 'cover-artists', 'focus': 'Music covers'},{'id': 'remix-culture', 'focus': 'Remixes'},{'id': 'viral-sounds', 'focus': 'Trending sounds'}]

          def log(msg): print(f"[W{WORKER}] {msg}", flush=True)

          def call_gemini(prompt):
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={GEMINI_KEY}"
              for attempt in range(5):
                  try:
                      resp = requests.post(url, json={"contents": [{"parts": [{"text": prompt}]}], "generationConfig": {"temperature": 0.8, "maxOutputTokens": 8192}}, timeout=60)
                      data = resp.json()
                      if "error" in data:
                          if "429" in str(data): time.sleep((2**attempt)*10); continue
                          return None
                      return data.get("candidates", [{}])[0].get("content", {}).get("parts", [{}])[0].get("text", "")
                  except: time.sleep(5)
              return None

          def discover(target):
              text = call_gemini(f"Discover Instagram/TikTok creators for African music. Target: {target['id']}, Focus: {target['focus']}. Return 100+ in JSON: {{\"creators\": [{{\"platform\": \"instagram\", \"username\": \"user\", \"content_type\": \"dance\"}}]}}")
              if not text: return []
              try:
                  s, e = text.find('{'), text.rfind('}')+1
                  return json.loads(text[s:e]).get('creators', []) if s >= 0 else []
              except: return []

          def insert(c):
              try:
                  return requests.post(f"{SUPABASE_URL}/rest/v1/voyo_pending_creators", headers={"apikey": SUPABASE_KEY, "Authorization": f"Bearer {SUPABASE_KEY}", "Content-Type": "application/json", "Prefer": "resolution=merge-duplicates"}, json={"platform": c.get('platform','instagram'), "username": c.get('username'), "content_type": c.get('content_type','music'), "status": "pending", "discovered_by": f"w{WORKER}"}, timeout=30).status_code in [200,201,409]
              except: return False

          my_targets = [t for i,t in enumerate(TARGETS) if i%3==WORKER]
          log(f"LOOP mode - {len(my_targets)} targets, Key #{KEY_INDEX}")
          total, loop = 0, 0
          while loop < 100:
              loop += 1
              log(f"=== LOOP {loop} ===")
              for t in my_targets:
                  creators = discover(t)
                  log(f"{t['id']}: {len(creators)}")
                  for c in creators: total += 1 if insert(c) else 0
                  time.sleep(random.uniform(2,5))
              log(f"Total: {total}")
              time.sleep(random.uniform(5,10))
          SCRIPT
          python discover.py
