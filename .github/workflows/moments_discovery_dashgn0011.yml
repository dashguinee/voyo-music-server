name: Moments Discovery dashgn0011

on:
  workflow_dispatch:
    inputs:
      wave:
        description: 'Discovery wave (1-4)'
        default: '1'
        type: string
      targets_per_worker:
        description: 'Targets per worker'
        default: '5'
        type: string

jobs:
  discovery:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        worker: [0, 1, 2]
    steps:
      - name: Setup
        run: |
          echo "Moments Discovery dashgn0011 Worker ${{ matrix.worker }}"
          pip install google-generativeai requests

      - name: Create discovery script
        run: |
          cat << 'SCRIPT' > discover.py
          import os
          import json
          import time
          import random
          import requests
          import google.generativeai as genai

          SUPABASE_URL = "https://anmgyxhnyhbyxzpjhxgx.supabase.co"
          SUPABASE_KEY = os.environ['SUPABASE_KEY']
          GEMINI_KEY = os.environ['GEMINI_KEY']
          WAVE = int(os.environ.get('WAVE', '1'))
          WORKER = int(os.environ.get('WORKER', '0'))
          TARGETS_PER_WORKER = int(os.environ.get('TARGETS_PER_WORKER', '5'))

          genai.configure(api_key=GEMINI_KEY)
          model = genai.GenerativeModel('gemini-2.0-flash-exp')

          DISCOVERY_WAVES = {
              1: [
                  {'id': 'instagram-afrobeats', 'focus': 'Afrobeats dance reels, Nigerian creators'},
                  {'id': 'tiktok-amapiano', 'focus': 'Amapiano dance challenges, SA creators'},
                  {'id': 'instagram-afro-fashion', 'focus': 'African fashion with music'},
                  {'id': 'tiktok-african-comedy', 'focus': 'African comedy skits with music'},
                  {'id': 'instagram-lagos-vibes', 'focus': 'Lagos lifestyle content'},
              ],
              2: [
                  {'id': 'ghana-highlife', 'focus': 'Ghanaian highlife and azonto'},
                  {'id': 'kenya-gengetone', 'focus': 'Kenyan gengetone and dance'},
                  {'id': 'francophone-coupe', 'focus': 'Coupe-decale, Ivorian music'},
                  {'id': 'uk-afroswing', 'focus': 'UK Afroswing creators'},
                  {'id': 'diaspora-vibes', 'focus': 'African diaspora content'},
              ],
              3: [
                  {'id': 'dance-challenges', 'focus': 'Viral African dance challenges'},
                  {'id': 'music-reactions', 'focus': 'Reactions to African music'},
                  {'id': 'street-performers', 'focus': 'Raw talent, undiscovered artists'},
                  {'id': 'producer-beats', 'focus': 'African producers, type beats'},
                  {'id': 'throwback-classics', 'focus': 'Classic African music clips'},
              ],
              4: [
                  {'id': 'emerging-artists', 'focus': 'New African artists, fresh sounds'},
                  {'id': 'live-performances', 'focus': 'Concert clips, live sessions'},
                  {'id': 'cover-artists', 'focus': 'African music covers'},
                  {'id': 'remix-culture', 'focus': 'Remixes and mashups'},
                  {'id': 'viral-sounds', 'focus': 'Trending African sounds'},
              ]
          }

          def log(msg):
              print(f"[MomentsDiscovery-W{WORKER}] {msg}", flush=True)

          def discover_creators(target):
              """Use Gemini to discover creators for a target"""
              prompt = f"""You are discovering Instagram and TikTok creators for an African music platform.

          Target: {target['id']}
          Focus: {target['focus']}

          Return EXACTLY 20 creator usernames in this JSON format:
          {{
              "creators": [
                  {{"platform": "instagram", "username": "example_user", "content_type": "dance"}},
                  {{"platform": "tiktok", "username": "example_user2", "content_type": "music"}}
              ]
          }}

          Focus on REAL, ACTIVE creators with African music content. Mix of popular and emerging."""

              try:
                  response = model.generate_content(prompt)
                  text = response.text
                  # Extract JSON
                  start = text.find('{')
                  end = text.rfind('}') + 1
                  if start >= 0 and end > start:
                      data = json.loads(text[start:end])
                      return data.get('creators', [])
              except Exception as e:
                  log(f"Gemini error: {e}")
              return []

          def insert_pending_creator(creator):
              """Insert creator to Supabase for later video fetching"""
              headers = {
                  "apikey": SUPABASE_KEY,
                  "Authorization": f"Bearer {SUPABASE_KEY}",
                  "Content-Type": "application/json",
                  "Prefer": "resolution=merge-duplicates"
              }
              data = {
                  "platform": creator.get('platform', 'instagram'),
                  "username": creator.get('username'),
                  "content_type": creator.get('content_type', 'music'),
                  "status": "pending",
                  "discovered_by": f"moments-discovery-w{WORKER}"
              }
              url = f"{SUPABASE_URL}/rest/v1/voyo_pending_creators"
              try:
                  resp = requests.post(url, headers=headers, json=data, timeout=30)
                  return resp.status_code in [200, 201, 409]
              except:
                  return False

          def main():
              log(f"Starting Moments Discovery - Wave {WAVE}, Worker {WORKER}")

              targets = DISCOVERY_WAVES.get(WAVE, DISCOVERY_WAVES[1])
              # Each worker handles different targets
              start_idx = WORKER * TARGETS_PER_WORKER
              my_targets = targets[start_idx:start_idx + TARGETS_PER_WORKER]

              log(f"Processing {len(my_targets)} targets")

              total_discovered = 0
              for target in my_targets:
                  log(f"Discovering: {target['id']}")
                  creators = discover_creators(target)
                  log(f"  Found {len(creators)} creators")

                  for creator in creators:
                      if insert_pending_creator(creator):
                          total_discovered += 1

                  time.sleep(random.uniform(1, 3))

              log(f"Complete: {total_discovered} creators discovered")

          if __name__ == "__main__":
              main()
          SCRIPT

      - name: Run discovery
        env:
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_KEY: ${{ secrets.GEMINI_KEY_1 }}
          WAVE: ${{ inputs.wave }}
          WORKER: ${{ matrix.worker }}
          TARGETS_PER_WORKER: ${{ inputs.targets_per_worker }}
        run: python discover.py
