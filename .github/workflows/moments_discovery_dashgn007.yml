name: Moments Discovery dashgn007

on:
  workflow_dispatch:
    inputs:
      wave:
        description: 'Discovery wave (1-4)'
        default: '1'
        type: string

jobs:
  discovery:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        worker: [0, 1, 2]
    steps:
      - name: Setup
        run: |
          echo "Moments Discovery dashgn007 Worker ${{ matrix.worker }}"
          pip install requests

      - name: Create discovery script
        run: |
          cat << 'SCRIPT' > discover.py
          import os
          import json
          import time
          import random
          import requests

          SUPABASE_URL = "https://anmgyxhnyhbyxzpjhxgx.supabase.co"
          SUPABASE_KEY = os.environ['SUPABASE_KEY']
          WORKER = int(os.environ.get('WORKER', '0'))
          WORKFLOW_OFFSET = int(os.environ.get('WORKFLOW_OFFSET', '0'))

          # 19 Gemini keys for rotation (removed leaked key)
          GEMINI_KEYS = [
              "AIzaSyAxXuWxcD1CN08lsoJlcUL6uBcLJEyXBFk",
              "AIzaSyA06zIDz7H5waHAI4Y7pm6goewWgf5fjSA",
              "AIzaSyCYrl0-t2xS0NZ4aSEQ-ZUZvCu-KoKftc8",
              "AIzaSyD10bR8ttgOxQok8rcOq7jc_yF00UBQn14",
              "AIzaSyBKZmoLt4bxNDZlq8LB9h0YMDWshgMxQ7M",
              "AIzaSyCwiS0cu23sVwxj2kVOU72zFkdXfpDQdes",
              "AIzaSyB86yrjm-J6IRhCAHxSBibyHiFtrHO3x8s",
              "AIzaSyDokhvEBX5O8UNO2oELV6b8yX3wjBmGJVc",
              "AIzaSyACh0veq7t8rzn6GQffS_5VSQlNN7g8rYc",
              "AIzaSyBiukubVZHnxQOHSmgs5KBePbXaOC0CVrA",
              "AIzaSyBlQtC75xy3mtvFh1jlD2V9hCL3ZWgdAL0",
              "AIzaSyCsz2Q9c1XcUpDHm-mpzdPScNCoqDCf6bg",
              "AIzaSyDYQp4_cczG_9ckibyp7Zf8L0TIbIxCnec",
              "AIzaSyAZvM9erouQMYMAUl6At83391uuQMj8Ckk",
              "AIzaSyCydxSRPNbN08nO6QXN95RR7UUdtDSQNX4",
              "AIzaSyCdWnesc8Svykwb0yF2UQl18_fsNJYOiVg",
              "AIzaSyBmIjEMvUnM80Pk3FcenKP_yoippgHkT1M",
              "AIzaSyBQsI8Z3mBF1dWuHBo3Sbv0Rpvt4zNwV_4",
              "AIzaSyAWqEvMZ5po-rX8ADwuc4ja6typ6YuGbeE",
          ]
          KEY_INDEX = (WORKFLOW_OFFSET + WORKER) % len(GEMINI_KEYS)
          GEMINI_KEY = GEMINI_KEYS[KEY_INDEX]

          DISCOVERY_TARGETS = [
              {'id': 'instagram-afrobeats', 'focus': 'Afrobeats dance reels, Nigerian creators'},
              {'id': 'tiktok-amapiano', 'focus': 'Amapiano dance challenges, SA creators'},
              {'id': 'instagram-afro-fashion', 'focus': 'African fashion with music'},
              {'id': 'tiktok-african-comedy', 'focus': 'African comedy skits with music'},
              {'id': 'instagram-lagos-vibes', 'focus': 'Lagos lifestyle content'},
              {'id': 'ghana-highlife', 'focus': 'Ghanaian highlife and azonto'},
              {'id': 'kenya-gengetone', 'focus': 'Kenyan gengetone and dance'},
              {'id': 'francophone-coupe', 'focus': 'Coupe-decale, Ivorian music'},
              {'id': 'uk-afroswing', 'focus': 'UK Afroswing creators'},
              {'id': 'diaspora-vibes', 'focus': 'African diaspora content'},
              {'id': 'dance-challenges', 'focus': 'Viral African dance challenges'},
              {'id': 'music-reactions', 'focus': 'Reactions to African music'},
              {'id': 'street-performers', 'focus': 'Raw talent, undiscovered artists'},
              {'id': 'producer-beats', 'focus': 'African producers, type beats'},
              {'id': 'throwback-classics', 'focus': 'Classic African music clips'},
              {'id': 'emerging-artists', 'focus': 'New African artists, fresh sounds'},
              {'id': 'live-performances', 'focus': 'Concert clips, live sessions'},
              {'id': 'cover-artists', 'focus': 'African music covers'},
              {'id': 'remix-culture', 'focus': 'Remixes and mashups'},
              {'id': 'viral-sounds', 'focus': 'Trending African sounds'},
          ]

          def log(msg):
              print(f"[MomentsDiscovery-W{WORKER}] {msg}", flush=True)

          def call_gemini(prompt, api_key, max_retries=5):
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}"
              for attempt in range(max_retries):
                  try:
                      resp = requests.post(url, json={
                          "contents": [{"parts": [{"text": prompt}]}],
                          "generationConfig": {"temperature": 0.8, "maxOutputTokens": 8192}
                      }, timeout=60)
                      data = resp.json()
                      if "error" in data:
                          error_msg = data["error"].get("message", "Unknown error")
                          if "429" in error_msg or "quota" in error_msg.lower():
                              wait_time = (2 ** attempt) * 10 + random.uniform(5, 15)
                              log(f"Rate limited, waiting {wait_time:.0f}s")
                              time.sleep(wait_time)
                              continue
                          return None, error_msg
                      text = data.get("candidates", [{}])[0].get("content", {}).get("parts", [{}])[0].get("text", "")
                      return text, None
                  except Exception as e:
                      log(f"Request error: {e}")
                      time.sleep(5)
              return None, "Max retries exceeded"

          def discover_creators(target):
              prompt = f"""You are discovering Instagram and TikTok creators for an African music platform.
          Target: {target['id']}
          Focus: {target['focus']}
          Return AS MANY creator usernames as possible (100+) in JSON:
          {{"creators": [{{"platform": "instagram", "username": "user", "content_type": "dance"}}]}}
          Focus on REAL, ACTIVE creators. Mix popular and emerging."""

              text, error = call_gemini(prompt, GEMINI_KEY)
              if error:
                  log(f"Gemini error: {error}")
                  return []
              try:
                  start = text.find('{')
                  end = text.rfind('}') + 1
                  if start >= 0 and end > start:
                      return json.loads(text[start:end]).get('creators', [])
              except:
                  pass
              return []

          def insert_creator(creator):
              headers = {"apikey": SUPABASE_KEY, "Authorization": f"Bearer {SUPABASE_KEY}",
                         "Content-Type": "application/json", "Prefer": "resolution=merge-duplicates"}
              data = {"platform": creator.get('platform', 'instagram'), "username": creator.get('username'),
                      "content_type": creator.get('content_type', 'music'), "status": "pending",
                      "discovered_by": f"moments-w{WORKER}"}
              try:
                  resp = requests.post(f"{SUPABASE_URL}/rest/v1/voyo_pending_creators", headers=headers, json=data, timeout=30)
                  return resp.status_code in [200, 201, 409]
              except:
                  return False

          def main():
              log(f"Starting LOOP Discovery - Worker {WORKER}, Key #{KEY_INDEX}")
              my_targets = [t for i, t in enumerate(DISCOVERY_TARGETS) if i % 3 == WORKER]
              log(f"Processing {len(my_targets)} targets in INFINITE LOOP")

              total = 0
              loop = 0
              while loop < 100:
                  loop += 1
                  log(f"=== LOOP {loop} ===")
                  for target in my_targets:
                      log(f"Discovering: {target['id']}")
                      creators = discover_creators(target)
                      log(f"  Found {len(creators)} creators")
                      for c in creators:
                          if insert_creator(c):
                              total += 1
                      time.sleep(random.uniform(2, 5))
                  log(f"Loop {loop} done. Total: {total}")
                  time.sleep(random.uniform(5, 10))
              log(f"FINAL: {total} creators in {loop} loops")

          if __name__ == "__main__":
              main()
          SCRIPT

      - name: Run discovery
        env:
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          WORKER: ${{ matrix.worker }}
          WORKFLOW_OFFSET: '3'
        run: python discover.py
