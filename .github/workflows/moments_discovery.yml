name: Moments Discovery

on:
  workflow_dispatch:

jobs:
  discovery:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        worker: [0, 1, 2]
    steps:
      - name: Setup
        run: pip install requests

      - name: Run discovery
        env:
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_KEYS: ${{ secrets.GEMINI_KEYS }}
          WORKER: ${{ matrix.worker }}
        run: |
          cat << 'SCRIPT' > discover.py
          import os, json, time, random, requests

          SUPABASE_URL = "https://anmgyxhnyhbyxzpjhxgx.supabase.co"
          SUPABASE_KEY = os.environ['SUPABASE_KEY']
          WORKER = int(os.environ.get('WORKER', '0'))

          GEMINI_KEYS = os.environ.get('GEMINI_KEYS', '').split(',')
          GEMINI_KEY = GEMINI_KEYS[WORKER % len(GEMINI_KEYS)]

          TARGETS = [
              {'id': 'instagram-afrobeats', 'focus': 'Afrobeats dance reels'},
              {'id': 'tiktok-amapiano', 'focus': 'Amapiano dance challenges'},
              {'id': 'instagram-afro-fashion', 'focus': 'African fashion with music'},
              {'id': 'tiktok-african-comedy', 'focus': 'African comedy skits'},
              {'id': 'instagram-lagos-vibes', 'focus': 'Lagos lifestyle'},
              {'id': 'ghana-highlife', 'focus': 'Ghanaian highlife'},
              {'id': 'kenya-gengetone', 'focus': 'Kenyan gengetone'},
              {'id': 'francophone-coupe', 'focus': 'Coupe-decale'},
              {'id': 'uk-afroswing', 'focus': 'UK Afroswing'},
              {'id': 'diaspora-vibes', 'focus': 'African diaspora'},
              {'id': 'dance-challenges', 'focus': 'Viral dance challenges'},
              {'id': 'music-reactions', 'focus': 'Music reactions'},
              {'id': 'street-performers', 'focus': 'Raw talent'},
              {'id': 'producer-beats', 'focus': 'African producers'},
              {'id': 'throwback-classics', 'focus': 'Classic clips'},
              {'id': 'emerging-artists', 'focus': 'New artists'},
              {'id': 'live-performances', 'focus': 'Concert clips'},
              {'id': 'cover-artists', 'focus': 'Music covers'},
              {'id': 'remix-culture', 'focus': 'Remixes'},
              {'id': 'viral-sounds', 'focus': 'Trending sounds'}
          ]

          def log(msg): print(f"[W{WORKER}] {msg}", flush=True)

          def call_gemini(prompt):
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={GEMINI_KEY}"
              for attempt in range(5):
                  try:
                      resp = requests.post(url, json={"contents": [{"parts": [{"text": prompt}]}], "generationConfig": {"temperature": 0.8, "maxOutputTokens": 8192}}, timeout=60)
                      data = resp.json()
                      if "error" in data:
                          err = str(data)
                          if "429" in err: time.sleep((2**attempt)*10); continue
                          log(f"Error: {data.get('error',{}).get('message','Unknown')}")
                          return None
                      return data.get("candidates", [{}])[0].get("content", {}).get("parts", [{}])[0].get("text", "")
                  except Exception as e: log(f"Request error: {e}"); time.sleep(5)
              return None

          def discover(target):
              text = call_gemini(f"Discover Instagram/TikTok creators for African music. Target: {target['id']}, Focus: {target['focus']}. Return 100+ in JSON: {{\"creators\": [{{\"platform\": \"instagram\", \"username\": \"user\", \"content_type\": \"dance\"}}]}}")
              if not text: return []
              try:
                  s, e = text.find('{'), text.rfind('}')+1
                  return json.loads(text[s:e]).get('creators', []) if s >= 0 else []
              except: return []

          def insert(c):
              try:
                  return requests.post(f"{SUPABASE_URL}/rest/v1/voyo_pending_creators", headers={"apikey": SUPABASE_KEY, "Authorization": f"Bearer {SUPABASE_KEY}", "Content-Type": "application/json", "Prefer": "resolution=merge-duplicates"}, json={"platform": c.get('platform','instagram'), "username": c.get('username'), "content_type": c.get('content_type','music'), "status": "pending", "discovered_by": f"w{WORKER}"}, timeout=30).status_code in [200,201,409]
              except: return False

          my_targets = [t for i,t in enumerate(TARGETS) if i%3==WORKER]
          log(f"Starting LOOP mode - {len(my_targets)} targets")
          total, loop = 0, 0
          while loop < 100:
              loop += 1
              log(f"=== LOOP {loop} ===")
              for t in my_targets:
                  creators = discover(t)
                  log(f"{t['id']}: {len(creators)}")
                  for c in creators: total += 1 if insert(c) else 0
                  time.sleep(random.uniform(2,5))
              log(f"Total: {total}")
              time.sleep(random.uniform(5,10))
          log(f"FINAL: {total} creators")
          SCRIPT
          python discover.py
